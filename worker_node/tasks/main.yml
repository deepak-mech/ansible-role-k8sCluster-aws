---
# tasks file for worker_node
- name: "Creating Repo for Kubernetes"
  shell: |
          cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
          [kubernetes]
          name=Kubernetes
          baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
          enabled=1
          gpgcheck=1
          repo_gpgcheck=1
          gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
          exclude=kubelet kubeadm kubectl
          EOF



- name: "Installing Docker & iproute-tc Software"
  package:
          name: "{{ item }}"
          state: present
  loop: "{{ package_name }}"

- name: "Installing K8s related Softwares"
  shell: yum install {{ item }} -y  --disableexcludes=kubernetes
  loop: "{{ k8s_package_name }}"

 
- name: "Starting Services"
  service:
          name: "{{ item }}"
          state: started
  loop: "{{ service_name }}"

- name: "Changing driver to systemd"
  copy:
          src: daemon.json
          dest: /etc/docker/

- name: "Restart Docker Service"
  service:
          name: docker
          state: restarted

- name: "Setting bridge nf-call-iptables value to 1"
  shell: |
           cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
           net.bridge.bridge-nf-call-ip6tables = 1
           net.bridge.bridge-nf-call-iptables = 1
           EOF

- name: "Restart Bridge Setting"
  shell: sysctl --system

- name: "Using Token"
  shell: "{{ token }}"

